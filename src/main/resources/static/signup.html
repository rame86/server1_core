<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입 테스트</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 500px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .info-msg { color: #666; font-size: 0.85em; margin-top: 5px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        hr { margin: 20px 0; border: 0; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <h2>회원가입 (추가 정보 입력)</h2>
    <p class="info-msg">반갑습니다! 가입을 위해 아래 정보를 완성해 주세요.</p>
    <hr>

    <form id="signupForm">
        <div class="form-group">
            <label>이메일</label>
		    <input type="email" id="email" name="email" th:value="${email}">
		    <button type="button" onclick="sendCode()">인증번호 받기</button>
        </div>
        
        <div id="authSection">
        	<label>인증번호</label>
        	<input type="text" id="authCode" placeholder="인증번호 6자리 입력">
        	<span id="timer" style="color: red;"></span>
        </div>

        <div class="form-group">
            <label>이름(닉네임)</label>
            <input type="text" id="name" required>
        </div>

        <div class="form-group">
            <label>비밀번호</label>
            <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
        </div>

        <div class="form-group">
            <label>전화번호</label>
            <input type="text" id="phone" placeholder="010-0000-0000">
        </div>

        <div class="form-group">
            <label>주소</label>
            <input type="text" id="address" placeholder="주소를 입력하세요">
        </div>

        <div class="form-group">
            <label>나이</label>
            <input type="number" id="age" placeholder="20">
        </div>

        <input type="hidden" id="provider">
        <input type="hidden" id="providerId">

        <button type="submit">회원가입 완료</button>
    </form>

<script>
    // 1. 페이지 로드 시 URL 파라미터 읽기 (기존과 동일)
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('email').value = urlParams.get('email') || '';
    document.getElementById('name').value = urlParams.get('nickname') || '';
    document.getElementById('provider').value = urlParams.get('provider') || '';
    document.getElementById('providerId').value = urlParams.get('providerId') || '';

    // [추가] 1-2. 인증번호 발송 함수
    // HTML에 <button type="button" onclick="sendCode()">인증번호 받기</button> 가 있어야 해요!
    async function sendCode() {
        const email = document.getElementById('email').value;
        if(!email) {
            alert("이메일이 없습니다.");
            return;
        }

        try {
            const response = await fetch('/member/SendVerification?email=' + email, {
                method: 'POST'
            });
            const result = await response.json();
            alert(result.message); // "인증번호가 발송되었습니다."
        } catch (error) {
            alert("메일 발송 중 오류가 발생했습니다.");
        }
    }

    // 2. 가입하기 버튼 클릭 이벤트
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault(); 

        // [수정] signupData에 authCode를 추가했어요!
        const signupData = {
            email: document.getElementById('email').value,
            name: document.getElementById('name').value,
            password: document.getElementById('password').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            age: document.getElementById('age').value,
            provider: document.getElementById('provider').value,
            providerId: document.getElementById('providerId').value,
            authCode: document.getElementById('authCode').value // 화면에 만든 인증번호 입력칸 ID
        };

        try {
            const response = await fetch('/member/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(signupData)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                localStorage.setItem('token', result.token);
                window.location.href = result.redirectUrl; 
            } else {
                // 인증번호가 틀리면 여기서 "인증번호가 일치하지 않습니다"가 뜰 거예요.
                alert("가입 실패: " + (result.message || "오류가 발생했습니다."));
            }
        } catch (error) {
            console.error("통신 에러:", error);
            alert("서버 연결에 실패했습니다.");
        }
    });
</script>
</body>
</html>