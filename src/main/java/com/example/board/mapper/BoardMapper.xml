<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.board.mapper.BoardMapper">

    <select id="findAll" resultType="com.example.board.dto.BoardDTO">
        SELECT 
            b.board_id AS boardId,
            b.category, 
            b.title, 
            b.content, 
            b.member_id AS memberId,
            b.view_count AS viewCount, 
            b.like_count AS likeCount, 
            b.comment_count AS commentCount, 
            b.is_artist_post AS isArtistPost,
            b.created_at AS createdAt,
            m.name AS authorName,        m.role AS authorRole,        'default_profile.png' AS profileImg FROM board.boards b
        LEFT JOIN public.member m ON b.member_id = m.member_id
        <where>
            <if test="category != null and category != '' and category != '전체'">
                b.category = #{category}
            </if>
        </where>
        ORDER BY b.created_at DESC
    </select>

    <select id="findById" resultType="com.example.board.dto.BoardDTO">
        SELECT 
            b.*, 
            b.board_id AS boardId,
            b.member_id AS memberId,
            m.name AS authorName, 
            m.role AS authorRole
        FROM board.boards b
        LEFT JOIN public.member m ON b.member_id = m.member_id
        WHERE b.board_id = #{id}
    </select>

    <select id="findPopularPosts" resultType="com.example.board.dto.BoardDTO">
    SELECT b.*, m.name AS authorName 
    FROM board.boards b
    JOIN public.member m ON b.member_id = m.member_id
    WHERE b.like_count > 50  ORDER BY b.like_count DESC
    LIMIT 3
    </select>

    <insert id="insert" parameterType="com.example.board.dto.BoardDTO" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO board.boards (
            category, 
            title, 
            content, 
            member_id, 
            is_artist_post
        )
        VALUES (
            #{category}, 
            #{title}, 
            #{content}, 
            #{memberId}, 
            <choose>
                <when test="authorRole == 'ARTIST'">TRUE</when>
                <otherwise>FALSE</otherwise>
            </choose>
        )
    </insert>

    <update id="incrementViewCount">
        UPDATE board.boards 
        SET view_count = view_count + 1 
        WHERE board_id = #{id}
    </update>

</mapper>