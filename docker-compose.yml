version: '3.8'

services:
  # 1. Redis 서비스 추가
  msa-redis:
    image: redis:alpine
    container_name: msa-redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - msa-network

  # 2. Core Service 설정 (기존 설정에서 Redis 환경변수 추가!)
  core-service:
    image: ssrabw/server1_core:latest
    container_name: core-service
    restart: always
    ports:
      - "8080:8080"
    networks:
      - msa-network
    environment:
      # 스프링 프로파일 설정
      SPRING_PROFILES_ACTIVE: prod
      
      # [중요] Redis 연결 정보 (이게 environment 안에 있어야 함!)
      SPRING_DATA_REDIS_HOST: msa-redis
      SPRING_DATA_REDIS_PORT: 6379
      
      # DB 설정
      SPRING_DATASOURCE_URL: jdbc:postgresql://main-db:5432/msa_core_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      
      # RabbitMQ 설정
      SPRING_RABBITMQ_HOST: rabbitmq

networks:
  msa-network:
    external: true